app 中间业务.天津.新建商品房交易资金监管

import 交款协议

bo 交款协议 // Hi
  // 来自持久化层
  协议编号
  房款金额
  首付流水号 null
  // 推理或计算得来
  已付金额 = 已付金额 + 首付金额 if 首付已付 for [首付, 定金, 二付, 尾款]
  未付金额 = 房款金额 - 已付金额
  付清 = 已付金额 == 房款金额
  首付已付 = 首付流水号.非空 for [首付, 二付, 尾款]
  定金已付 = 定金流水号.非空 or 定金金额.空
  首付未付 = not 首付已付 for [首付, 定金, 二付, 尾款]
  银行 : 银行
  转出账户 : 账户 if 账号 == 转出账号
  pk 协议编号
end

bo 交款登记簿
  交易日期 default 机器日期
  交款协议 : 协议编号
end

// 约定，请求报文中没有孤零的字段，都应归属于某个bo？
bp 交款登记簿::增加 // 即：交款
  未付清
  交款金额 > 0.00
  交款金额 == 首付金额 if 交款次数 == 首付 for [首付, 定金, 尾款]
  交款金额 <= 未付金额 if 交款次数 == 二付
  交款金额 == 账务流水[贷款].交易金额 if 交款次数 == 二付 and 付款方式 == 贷款
  交款金额 == 账务流水[贷款].交易金额 + 账务流水[组合贷款].交易金额 if 交款次数 == 二付 and 付款方式 == 组合贷款
  交款金额 == 账务流水[支票].交易金额 if 付款方式 == 他行支票
  支票账户 != 监管账户 if 付款方式 == 本行支票
  转账 if 付款方式 != 贷款 and 付款方式 != 他行支票
  交款协议.修改 (首付流水号 = 交易流水号, 首付行号 = 交易机构, 首付日期 = 交易日期) if 交款次数 == 首付金额 for [首付, 定金, 尾款]
  交款协议.修改 (二付流水号 = 交易流水号, 二付行号 = 交易机构, 二付日期 = 交易日期, 二付金额 = 交易金额) if 交款次数 == 二付
  交款登记簿.增加
  if 首付
    首付流水号 = 交易流水号
  else if 二付
    二付流水号 = 交易流水号
  else
    尾款流水号 = 交易流水号
  end
  loop 交款登记簿 if 交易日期 == "2012.01.02"
    交款金额合计 = 交款金额合计 + 交款金额
  end
  {交款次数, 交款金额} = 首付未付 ? {首付, 首付金额} : 定金未付 ? {定金, 定金金额} : 二付未付 ? {二付} : {尾款, 未付金额}
end
